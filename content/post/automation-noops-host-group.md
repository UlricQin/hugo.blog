+++
date = "2015-03-13T15:55:04+08:00"
menu = "main"
tags = ["sre"]
title = "自动化运维之路-机器分组管理"

+++

上一篇我们提到一个机器分组管理的系统HostManager，那这个分组规范到底应该如何制定呢？这是个大问题。首先我们想到的应该是有哪些场景要用到这些分组。脑洞打开……

#### 部署系统

对于部署系统来说，上线的粒度通常是模块，比如要对falcon这个项目的judge模块做上线（当然，一次上线也可以上多个模块），那此时就要操作该模块所在的机器列表了。部署系统的本质，无非就是按照某个并发策略去一批机器上执行某个脚本，那此处的这一批机器就是有分组需求的。故而，我们在设计机器分组的时候要能够把模块所部署的机器列表归为一组。

#### 预算平台

从部署系统一下子跳到预算平台，思维有点跳跃哈，笔者是想到哪里写到哪里，见谅~之所以突然想到预算平台，是因为刚才提到某个项目的一个模块所部署的机器要归为一组。那项目这一层粒度呢？一个项目显然是要一批机器来run的，那这批机器是否需要归为一组呢？显然是需要的，因为我们通常做预算的最小单位就是项目，falcon这个项目要扩容，那我们提预算的时候就要知道现在这个项目用了多少机器，机器的资源利用率等情况，于是，run某个项目的一批机器也要可以归为一组

#### 资源利用率统计平台

我们刚才提到做预算的时候要知道某个项目用了多少机器，机器的资源利用率情况，那这些信息呢应该是可以从资源利用率统计平台得到的，统计平台在做资源统计的时候不但会以项目为粒度，还通常会以部门为粒度，每个部门可能对应一个运维团队，所以也可以归纳为：不同的运维同队管理的机器也有分组需求

#### 监控系统

监控系统在什么地方用到组呢？比如我们要给DINP这个项目的scheduler模块配置报警策略，scheduler模块可能部署在多台机器上，那此时我们就需要把这多台机器做成一个组，然后为这个组绑定报警策略模板了。因为这样一来，这个组里即使新加机器也会自动生效相关监控策略。稍等，这个分组需求这不是和部署系统的分组需求一致么？都是要根据项目模块分组。的确如此，大部分情况下两个系统需求一致。但有的时候监控系统对组的粒度要求更细，举个例子：DINP-scheduler这个模块分为master和slave，两个进程名称分别叫scheduler-master和scheduler-slave，那我们在配置进程存活监控的时候就需要比模块这个粒度更细的分组了，比如此处就是要把scheduler-master部署的那几台机器作为一组，把scheduler-slave部署的那几台机器作为另一组。

此时有的同学可能还是会存疑，scheduler这个模块既然分为master和slave，那部署的时候也应该是分成两个组，做成两次部署任务吧，诚然，如果scheduler-master和scheduler-slave发布包都不同，那做成两次部署任务是合理的。但是做过部署的人应该都清楚一个准则，就是发布包尽量做成一样的，区别通过远端配置或者启动参数等手段来搞。于是乎，有的场景下scheduler可能是一个部署任务搞定了master和slave！但是监控仍然要分开，对master的监控项并不适用于slave，so，监控系统实际比部署系统对机器分组粒度的要求更细。

思维神游一下，刚才提到一个词叫部署任务，一次部署看起来不一定跟项目模块一一对应，以后针对一次部署任务的抽象就叫task好了，嗯，不错

#### 权限系统

我们现在讨论的是机器分组，权限系统跟机器分组的关系在哪里呢？一个大型互联网公司，机器都是成千上万的，用ssh信任关系或者机器密码的方式来管理登陆是不合适的，所以大家通常会开发一个跳板机来专门处理登陆请求，然后在通过跳板机登陆其他机器的时候就可以与自己公司研发的权限系统挂钩。哪些人可以登陆哪些机器就需要在中心端配置了。那么问题来了，*我是falcon项目的sre（运维工程师，有的公司叫op），我自然可以登陆falcon所在的所有机器，同时我又是DINP的sre，那我也应该可以登陆DINP的所有机器*。那我们应该如何抽象呢？注意刚才我提到的斜线部分的话，这里提到了两个重要概念，一个是项目，一个是角色，一个人，只有是某个项目的合适角色的时候，才能登陆这个项目部署的机器，那看起来如果机器完全隶属于项目的话权限这个事情还是比较简单的。

#### 其他自定义批量操作

举个例子，假设falcon这个项目部署在多个idc，我现在要对idc1的那部分falcon机器做个什么操作，此时应该如何抽象呢？还应该把这部分机器单独做成一个组么？笔者觉得是不需要的，换句话说，机器所属的idc不应该作为分组依据。为啥呢？因为在某一时刻机器只隶属于一个idc，当然，机器从一个idc搬迁到另一个idc之后，在之后的时刻就隶属于另一个idc了，而这种唯一确定的机器信息应该作为属性。比如机器有24个核，有128G内存，属于idc1，这都是机器的属性，无需为其建组。

机器与组是多对多关系，即：一个机器可以属于多个组，一个组可以有多个机器

#### 组的包含问题

比如falcon-graph这个模块部署了20台机器，这20台机器可以做成一个组，falcon这个项目使用了60台机器，可以做成一个组，falcon这个项目是sa这个部门的，sa这个部门有500台机器，也可以做成一个组。那么问题来了，如果falcon-graph要扩容10台新机器，我们是不是要把这10台机器分别加到falcon-graph这个组中、falcon这个组中、sa这个组中？

如果真的要这么麻烦，那维护人员就哭了……所以我们不能这么干。我们希望的方式是往falcon-graph这个组增加10台机器之后，falcon这个组和sa这个组中也自动增加这10台机器。既然如此，我们可以不维护falcon和sa这个组，要获取falcon或sa组内机器的时候动态计算来获取。嗯，有没有感觉这像是一个树形结构？

```
root
  |- dba
    |- migration
  |- sa
    |- falcon
      |- graph
      |- judge
      |- gatway
    |- dinp
      |- scheduler
```

OK，假设我们就用树形结构来表示机器分组，看一下是否可以完全满足需求~

#### Point1：树形结构的上层，体现的是组织架构

首先，树有个根，根代表的是公司节点；根下面是部门，比如miui部门，dba部门，sa部门；部门下面是运维组，比如dba部门有四个运维人员，两个运维miui的数据库，两个运维游戏部门的数据库，miui-db的机器与game-db的机器是不混用的，故而我们可以在dba部门下面分出两个运维组。这么做，虽然层次比较深：公司>部门>运维组，不过有个大好处，我们可以在运维组这个层面绑定一个机器基础监控策略模板，这个运维组下面的所有机器出了问题，就可以发报警给这个运维组的人。如果公司更大，人员职责划分更精细，运维组是否可以嵌套呢？笔者目前还没想的太明白，感觉可以嵌套，没有发现明显缺点。姑且就暂且设计为可以嵌套好了。

#### Point2：最小粒度的运维组下面应该是Project节点

Project是一个很重要的实体，它有以下特性：

- Project通常包含多个模块，模块通常是上线单位
- Project有DEV/QA/SRE/PM，多种不同角色的人才能一起完成一个项目
- Project有域名资产，有机器资产，即：我们可以说某个域名是属于某个Project的，某些机器是用于部署某个Project的，当然，由于项目可以混部，一台机器可以被多个项目共用。
- Project在公司层面应该有个唯一的名称，比如监控系统叫falcon，PaaS平台叫dinp
- Project可以更换挂载的上层运维组节点，比如Project因为公司战略调整有可能从一个部门划归为另一部门，此时只需要更换Project的挂载点即可。要达到这样的效果，需要达到上一条要求：Project在公司层面应该有个唯一的名称，否则迁移的时候容易名称冲突。

#### Point3：Project节点下面**无需**是模块节点

这个观点比较奇怪哈，项目下面不就应该是模块节点么？为啥说**无需**是模块节点呢？

通常情况下的确如此，比如falcon项目下面可能有graph、judge等模块，很清晰。但这个无需强制，项目的模块也无需作为实体体现在树上，因为毫无意义。笔者觉得，Project的下层节点用户可以任意创建，任意嵌套，觉得怎么管理机器方便就怎么来。但是推荐方式是按照模块来划分。

#### Point4：机器只能挂载在叶子节点

这样以后系统处理起来方便，没有理由把机器挂载在上层节点。

#### 结语

看起来组织为树形结构问题不大，你觉得呢？姑且这么设计，之后我们挨个系统做设计的时候看是否OK
