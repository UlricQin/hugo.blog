+++
date = "2015-08-07T13:01:07+08:00"
menu = "main"
tags = ["Architecture", "Interview"]
title = "[架构场景] 编写一个公司内部短信邮件网关，如何提高吞吐量"

+++

想收集一系列“架构场景”相关的文章，谁看到好的这方面的文章或书求推荐。描述一下需求来源、解决思路、最终方案，相信还是蛮有用的。今天我先写一个自己工作中遇到的，希望对大家有帮助。

# 问题背景

我们的系统需要发送报警邮件、报警短信，正常情况下每天有上万条，如果某个基础服务挂了，相关联的上游服务可能都会受影响，这将产生大面积报警，于是要发送的报警邮件、报警短信也会有个高峰。发邮件我们有内部的smtp服务器，走smtp协议即可，发短信的话内部有个组提供了thrift接口（一般公司如果要发短信，可以联系一些通道运营商）。

# 需求细化

要求写一个组件，专门负责发送报警，形式可以支持短信，可以支持邮件，所以要封装smtp和thrift接口；组件对外暴露http接口即可，其他组件可以方便调用。OK，大方向上就是这样的需求，如果让你来实现，怎么搞？大家尽量自己思考一下，动动脑，再看后面的文字，这样帮助才会比较大。

# 思路分析

看起来其实挺简单的，就是写一个web服务即可，提供一个http接口，负责发送邮件或短信。如果要发送的是邮件，就转而调用smtp服务器，如果要发送的是短信，就调用thrift接口。

OK，那我问几个问题。

*想没想过依赖的服务有个容量上限？*

这个发送邮件的smtp服务器和发送短信的thrift接口都是别的组提供的，肯定是有容量上限的，量太大，会把人家打挂的。所以，我们不能玩命的去调用人家，要有个限度。最简单的，比如我们要有个并发控制，只有有限的线程去持续调用，这个具体数目可以通过配置文件指定，比如指定5个，那就要保证最多有5个线程去并发调用后面的邮件、短信发送接口，有了这个限制之后，就可以保证不把后端打死了。

*如果流量高峰期超过了你的处理能力怎么办？*

你可能会答：水平扩容。毕竟这只是一个转发服务，封装了后台两个接口，本身无状态，可以水平扩展。但是我们上个问题已经讨论了，我们可以水平扩展，但是后端的接口提供方是有容量上限的，我们受限于他。所以，当接收到的发送量大于接口的消费能力的时候就会有积压，就会变得响应缓慢，因为http处理接口接收到request之后，在等待后端的发送线程，但是迟迟得不到响应，这就无法快速返回http response了，调用方就会感觉我们响应缓慢。所以，我们要引入另一个机制：加Queue。从http接口接收到要发送的报警信息之后，立马塞到Queue中，立马返回http response，这个过程可以做得很快。然后不断去轮询缓冲Queue，看现在是否有要发送的报警短信、邮件，有，就发送，没有，sleep 200个毫秒继续询问。嗯，这样处理了之后是不是顺眼多了。

# 最终方案

1. 编写一个web模块，只有一个http接口，就是接收报警的。
2. 收到之后如果发现是个报警短信，就塞到短信队列，如果是报警邮件，就塞到邮件队列。
3. 为邮件发送接口搞一个线程池，根据用户配置，创建相应的线程数，为短信发送接口搞另一个线程池，根据用户配置，创建相应线程数。
4. 额外再搞两个线程，一个去持续轮询短信队列，一个去持续轮询邮件队列，发现有待发送的短信、邮件，调用线程池去发送
5. 队列可以使用本地内存队列，也可以使用外部队列，比如Redis，或者MySQL

搞定！
